<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crystal Match - –¢—Ä–∏ –≤ —Ä—è–¥</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Arial', sans-serif;
            color: white;
            overflow: hidden;
            user-select: none;
        }

        .container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 500px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .stats {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: bold;
        }

        .stat-value {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 15px;
            min-width: 60px;
            text-align: center;
        }

        .game-board-container {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 25px;
            padding: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(15px);
        }

        #game-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 8px;
        }

        .cell {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .cell::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .cell:hover::before {
            opacity: 1;
        }

        .gem {
            width: 35px;
            height: 35px;
            border-radius: 10px;
            position: relative;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .gem::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, transparent 50%);
            border-radius: 8px;
        }

        .gem.selected {
            transform: scale(1.2);
            box-shadow: 0 0 25px gold;
            z-index: 10;
        }

        .gem.moving {
            z-index: 100;
        }

        .gem.exploding {
            animation: explode 0.6s ease-out forwards;
        }

        .gem.falling {
            animation: fall 0.5s ease-in;
        }

        .gem.spawning {
            animation: spawn 0.5s ease-out;
        }

        /* –¶–≤–µ—Ç–∞ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ */
        .gem-1 { background: linear-gradient(135deg, #FF6B6B, #FF8E8E); } /* –ö—Ä–∞—Å–Ω—ã–π */
        .gem-2 { background: linear-gradient(135deg, #4ECDC4, #88D9E6); } /* –ë–∏—Ä—é–∑–æ–≤—ã–π */
        .gem-3 { background: linear-gradient(135deg, #FFD166, #FFE8A3); } /* –ñ–µ–ª—Ç—ã–π */
        .gem-4 { background: linear-gradient(135deg, #06D6A0, #6AFFD6); } /* –ó–µ–ª–µ–Ω—ã–π */
        .gem-5 { background: linear-gradient(135deg, #118AB2, #5BC0EB); } /* –°–∏–Ω–∏–π */
        .gem-6 { background: linear-gradient(135deg, #9B5DE5, #C78FFF); } /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π */
        .gem-7 { background: linear-gradient(135deg, #F15BB5, #FFA8E0); } /* –†–æ–∑–æ–≤—ã–π */

        .controls {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #FF6B6B, #FF8E8E);
            border: none;
            border-radius: 20px;
            color: white;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(255, 107, 107, 0.6);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-premium {
            background: linear-gradient(135deg, #FFD166, #FFE8A3);
            color: #333;
            box-shadow: 0 8px 20px rgba(255, 209, 102, 0.4);
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes explode {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.7; }
            100% { transform: scale(0); opacity: 0; }
        }

        @keyframes fall {
            0% { transform: translateY(-100px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        @keyframes spawn {
            0% { transform: scale(0) rotate(-180deg); }
            70% { transform: scale(1.1) rotate(10deg); }
            100% { transform: scale(1) rotate(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç—ã —á–∞—Å—Ç–∏—Ü */
        .particle {
            position: absolute;
            pointer-events: none;
            border-radius: 50%;
            animation: particle-float 1s ease-out forwards;
        }

        @keyframes particle-float {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 25px;
            padding: 30px;
            text-align: center;
            max-width: 90%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            animation: modal-appear 0.5s ease-out;
        }

        @keyframes modal-appear {
            from {
                transform: scale(0.7) translateY(50px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .combo-popup {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            color: gold;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            animation: combo-pop 1s ease-out forwards;
            pointer-events: none;
            z-index: 100;
        }

        @keyframes combo-pop {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -100%) scale(0.8);
                opacity: 0;
            }
        }

        .level-progress {
            width: 100%;
            max-width: 500px;
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 8px;
        }

        .progress-bar {
            height: 12px;
            background: linear-gradient(90deg, #FF6B6B, #4ECDC4, #118AB2);
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 500px) {
            .cell {
                width: 35px;
                height: 35px;
            }
            
            .gem {
                width: 28px;
                height: 28px;
            }
            
            .header {
                padding: 10px;
            }
            
            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="stats">
                <div class="stat-item">
                    <span>üéØ –û—á–∫–∏:</span>
                    <div class="stat-value" id="score">0</div>
                </div>
                <div class="stat-item">
                    <span>‚≠ê –•–æ–¥—ã:</span>
                    <div class="stat-value" id="moves">25</div>
                </div>
                <div class="stat-item">
                    <span>üèÜ –£—Ä–æ–≤–µ–Ω—å:</span>
                    <div class="stat-value" id="level">1</div>
                </div>
            </div>
            <div class="stats">
                <div class="stat-item">
                    <span>üíé –¶–µ–ª—å:</span>
                    <div class="stat-value" id="target">1000</div>
                </div>
                <div class="stat-item">
                    <span>‚ö° –ö–æ–º–±–æ:</span>
                    <div class="stat-value" id="combo">x1</div>
                </div>
            </div>
        </div>

        <div class="game-board-container">
            <div id="game-board"></div>
        </div>

        <div class="level-progress">
            <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
        </div>

        <div class="controls">
            <button class="btn" id="hint-btn">üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞</button>
            <button class="btn btn-premium" id="premium-btn">üåü –ü–†–ï–ú–ò–£–ú</button>
            <button class="btn" id="restart-btn">üîÑ –ó–∞–Ω–æ–≤–æ</button>
        </div>
    </div>

    <div id="win-modal" class="modal hidden">
        <div class="modal-content">
            <h2>üéâ –ü–æ–±–µ–¥–∞! üéâ</h2>
            <p>–í—ã –ø—Ä–æ—à–ª–∏ —É—Ä–æ–≤–µ–Ω—å!</p>
            <p>–û—á–∫–∏: <span id="final-score">0</span></p>
            <p>–ö–æ–º–±–æ: x<span id="final-combo">1</span></p>
            <button class="btn" id="next-level-btn">–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å</button>
        </div>
    </div>

    <script>
        // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM WEB APP =====
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.BackButton.hide();

        // ===== –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï =====
        const BOARD_SIZE = 8;
        const GEM_TYPES = 7;
        const LEVEL_TARGETS = [1000, 2500, 5000, 10000, 20000];
        const LEVEL_MOVES = [25, 22, 20, 18, 15];

        let gameState = {
            score: 0,
            moves: 25,
            level: 1,
            target: 1000,
            combo: 1,
            comboMultiplier: 1,
            selectedGem: null,
            board: [],
            isAnimating: false,
            premium: false
        };

        // ===== –≠–õ–ï–ú–ï–ù–¢–´ DOM =====
        const gameBoard = document.getElementById('game-board');
        const scoreElement = document.getElementById('score');
        const movesElement = document.getElementById('moves');
        const levelElement = document.getElementById('level');
        const targetElement = document.getElementById('target');
        const comboElement = document.getElementById('combo');
        const progressBar = document.getElementById('progress-bar');
        const winModal = document.getElementById('win-modal');
        const finalScoreElement = document.getElementById('final-score');
        const finalComboElement = document.getElementById('final-combo');

        // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ì–†–´ =====
        function initGame() {
            createBoard();
            renderBoard();
            updateUI();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–º–∏—É–º-—Å—Ç–∞—Ç—É—Å–∞ (–≤ —Ä–µ–∞–ª—å–Ω–æ–π –∏–≥—Ä–µ —ç—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —Å –±—ç–∫–µ–Ω–¥–∞)
            checkPremiumStatus();
        }

        function createBoard() {
            gameState.board = [];
            for (let row = 0; row < BOARD_SIZE; row++) {
                gameState.board[row] = [];
                for (let col = 0; col < BOARD_SIZE; col++) {
                    let gemType;
                    do {
                        gemType = Math.floor(Math.random() * GEM_TYPES) + 1;
                    } while (hasMatchAt(row, col, gemType));
                    
                    gameState.board[row][col] = gemType;
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ö–æ–¥—ã
            if (!hasPossibleMoves()) {
                createBoard(); // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –¥–æ—Å–∫—É –µ—Å–ª–∏ –Ω–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ö–æ–¥–æ–≤
            }
        }

        function hasMatchAt(row, col, gemType) {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
            if (col >= 2 && 
                gameState.board[row][col-1] === gemType && 
                gameState.board[row][col-2] === gemType) {
                return true;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
            if (row >= 2 && 
                gameState.board[row-1] && 
                gameState.board[row-1][col] === gemType && 
                gameState.board[row-2][col] === gemType) {
                return true;
            }
            
            return false;
        }

        function renderBoard() {
            gameBoard.innerHTML = '';
            
            for (let row = 0; row < BOARD_SIZE; row++) {
                for (let col = 0; col < BOARD_SIZE; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    
                    const gem = document.createElement('div');
                    gem.className = `gem gem-${gameState.board[row][col]}`;
                    gem.dataset.type = gameState.board[row][col];
                    
                    cell.appendChild(gem);
                    gameBoard.appendChild(cell);
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
                    cell.addEventListener('click', () => handleCellClick(row, col));
                }
            }
        }

        // ===== –û–°–ù–û–í–ù–ê–Ø –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê =====
        function handleCellClick(row, col) {
            if (gameState.isAnimating || gameState.moves <= 0) return;
            
            const clickedGem = { row, col, type: gameState.board[row][col] };
            
            if (!gameState.selectedGem) {
                // –ü–µ—Ä–≤—ã–π –≤—ã–±–æ—Ä
                gameState.selectedGem = clickedGem;
                selectGem(row, col);
            } else {
                // –í—Ç–æ—Ä–æ–π –≤—ã–±–æ—Ä - –ø–æ–ø—ã—Ç–∫–∞ –æ–±–º–µ–Ω–∞
                const selected = gameState.selectedGem;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å–µ–¥—Å—Ç–≤–∞
                if (areNeighbors(selected, clickedGem)) {
                    gameState.isAnimating = true;
                    swapGems(selected, clickedGem).then(success => {
                        if (!success) {
                            // –ï—Å–ª–∏ –æ–±–º–µ–Ω –Ω–µ –ø—Ä–∏–≤–µ–ª –∫ –º–∞—Ç—á—É, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
                            swapGems(clickedGem, selected);
                        } else {
                            // –£—Å–ø–µ—à–Ω—ã–π –æ–±–º–µ–Ω - —Ç—Ä–∞—Ç–∏–º —Ö–æ–¥
                            gameState.moves--;
                            updateUI();
                            checkWinCondition();
                        }
                        gameState.selectedGem = null;
                        gameState.isAnimating = false;
                    });
                } else {
                    // –í—ã–±–æ—Ä –¥—Ä—É–≥–æ–π —Ñ–∏—à–∫–∏
                    clearSelection();
                    gameState.selectedGem = clickedGem;
                    selectGem(row, col);
                }
            }
        }

        function areNeighbors(gem1, gem2) {
            const rowDiff = Math.abs(gem1.row - gem2.row);
            const colDiff = Math.abs(gem1.col - gem2.col);
            return (rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1);
        }

        function selectGem(row, col) {
            const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
            const gem = cell.querySelector('.gem');
            gem.classList.add('selected');
        }

        function clearSelection() {
            document.querySelectorAll('.gem.selected').forEach(gem => {
                gem.classList.remove('selected');
            });
        }

        async function swapGems(gem1, gem2) {
            // –í–∏–∑—É–∞–ª—å–Ω—ã–π –æ–±–º–µ–Ω
            await animateSwap(gem1, gem2);
            
            // –õ–æ–≥–∏—á–µ—Å–∫–∏–π –æ–±–º–µ–Ω
            const temp = gameState.board[gem1.row][gem1.col];
            gameState.board[gem1.row][gem1.col] = gameState.board[gem2.row][gem2.col];
            gameState.board[gem2.row][gem2.col] = temp;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ç—á–µ–π
            const matches = findMatches();
            if (matches.length > 0) {
                await processMatches(matches);
                return true;
            } else {
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
                const temp = gameState.board[gem1.row][gem1.col];
                gameState.board[gem1.row][gem1.col] = gameState.board[gem2.row][gem2.col];
                gameState.board[gem2.row][gem2.col] = temp;
                
                await animateSwap(gem2, gem1);
                return false;
            }
        }

        function animateSwap(gem1, gem2) {
            return new Promise(resolve => {
                const cell1 = document.querySelector(`.cell[data-row="${gem1.row}"][data-col="${gem1.col}"] .gem`);
                const cell2 = document.querySelector(`.cell[data-row="${gem2.row}"][data-col="${gem2.col}"] .gem`);
                
                cell1.style.transform = `translate(${(gem2.col - gem1.col) * 100}%, ${(gem2.row - gem1.row) * 100}%)`;
                cell2.style.transform = `translate(${(gem1.col - gem2.col) * 100}%, ${(gem1.row - gem2.row) * 100}%)`;
                
                setTimeout(() => {
                    cell1.style.transform = '';
                    cell2.style.transform = '';
                    renderBoard(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–æ—Å–∫—É
                    resolve();
                }, 300);
            });
        }

        function findMatches() {
            const matches = [];
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã—Ö –º–∞—Ç—á–µ–π
            for (let row = 0; row < BOARD_SIZE; row++) {
                for (let col = 0; col < BOARD_SIZE - 2; col++) {
                    const gemType = gameState.board[row][col];
                    if (gemType && 
                        gemType === gameState.board[row][col+1] && 
                        gemType === gameState.board[row][col+2]) {
                        
                        let matchLength = 3;
                        while (col + matchLength < BOARD_SIZE && gameState.board[row][col+matchLength] === gemType) {
                            matchLength++;
                        }
                        
                        matches.push({
                            row: row,
                            col: col,
                            length: matchLength,
                            horizontal: true,
                            type: gemType
                        });
                        
                        col += matchLength - 1;
                    }
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö –º–∞—Ç—á–µ–π
            for (let col = 0; col < BOARD_SIZE; col++) {
                for (let row = 0; row < BOARD_SIZE - 2; row++) {
                    const gemType = gameState.board[row][col];
                    if (gemType && 
                        gameState.board[row+1] && 
                        gemType === gameState.board[row+1][col] && 
                        gemType === gameState.board[row+2][col]) {
                        
                        let matchLength = 3;
                        while (row + matchLength < BOARD_SIZE && gameState.board[row+matchLength] && gameState.board[row+matchLength][col] === gemType) {
                            matchLength++;
                        }
                        
                        matches.push({
                            row: row,
                            col: col,
                            length: matchLength,
                            horizontal: false,
                            type: gemType
                        });
                        
                        row += matchLength - 1;
                    }
                }
            }
            
            return matches;
        }

        async function processMatches(matches) {
            if (matches.length === 0) return;
            
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–º–±–æ
            gameState.comboMultiplier += 0.2;
            gameState.combo = Math.floor(gameState.comboMultiplier);
            
            // –í–∑—Ä—ã–≤ –º–∞—Ç—á–µ–π –∏ –ø–æ–¥—Å—á–µ—Ç –æ—á–∫–æ–≤
            let totalScore = 0;
            const explodingGems = new Set();
            
            matches.forEach(match => {
                const points = match.length * 100 * gameState.combo;
                totalScore += points;
                
                for (let i = 0; i < match.length; i++) {
                    const row = match.horizontal ? match.row : match.row + i;
                    const col = match.horizontal ? match.col + i : match.col;
                    
                    const key = `${row},${col}`;
                    if (!explodingGems.has(key)) {
                        explodingGems.add(key);
                        explodeGem(row, col, match.type);
                    }
                }
                
                // –ü–æ–∫–∞–∑ –∫–æ–º–±–æ-–ø–æ–ø–∞–ø–∞
                showComboPopup(match);
            });
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—á–∫–æ–≤
            gameState.score += totalScore;
            
            // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –≤–∑—Ä—ã–≤–∞
            await new Promise(resolve => setTimeout(resolve, 600));
            
            // –£–¥–∞–ª–µ–Ω–∏–µ –≤–∑–æ—Ä–≤–∞–Ω–Ω—ã—Ö —Ñ–∏—à–µ–∫ –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—É—Å—Ç–æ—Ç
            await fillEmptySpaces();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –º–∞—Ç—á–µ–π –ø–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
            const newMatches = findMatches();
            if (newMatches.length > 0) {
                await processMatches(newMatches);
            } else {
                // –°–±—Ä–æ—Å –∫–æ–º–±–æ –µ—Å–ª–∏ —Ü–µ–ø–æ—á–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
                gameState.comboMultiplier = 1;
                gameState.combo = 1;
            }
            
            updateUI();
        }

        function explodeGem(row, col, type) {
            const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
            if (!cell) return;
            
            const gem = cell.querySelector('.gem');
            if (gem) {
                gem.classList.add('exploding');
                
                // –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Å—Ç–∏—Ü
                createParticles(cell, type);
                
                setTimeout(() => {
                    gameState.board[row][col] = 0;
                }, 300);
            }
        }

        function createParticles(cell, type) {
            const rect = cell.getBoundingClientRect();
            const color = getComputedStyle(cell.querySelector('.gem')).background;
            
            for (let i = 0; i < 8; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.background = color;
                particle.style.width = '8px';
                particle.style.height = '8px';
                particle.style.left = rect.left + rect.width / 2 + 'px';
                particle.style.top = rect.top + rect.height / 2 + 'px';
                
                const angle = (i / 8) * Math.PI * 2;
                const distance = 50 + Math.random() * 50;
                particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
                particle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
                
                document.body.appendChild(particle);
                
                setTimeout(() => {
                    particle.remove();
                }, 1000);
            }
        }

        function showComboPopup(match) {
            const cell = document.querySelector(`.cell[data-row="${match.row}"][data-col="${match.col}"]`);
            const rect = cell.getBoundingClientRect();
            
            const popup = document.createElement('div');
            popup.className = 'combo-popup';
            popup.textContent = `COMBO x${gameState.combo}!`;
            popup.style.left = rect.left + rect.width / 2 + 'px';
            popup.style.top = rect.top + rect.height / 2 + 'px';
            
            document.body.appendChild(popup);
            
            setTimeout(() => {
                popup.remove();
            }, 1000);
        }

        async function fillEmptySpaces() {
            // –ü–∞–¥–µ–Ω–∏–µ —Ñ–∏—à–µ–∫ —Å–≤–µ—Ä—Ö—É
            for (let col = 0; col < BOARD_SIZE; col++) {
                let emptySpaces = 0;
                
                for (let row = BOARD_SIZE - 1; row >= 0; row--) {
                    if (gameState.board[row][col] === 0) {
                        emptySpaces++;
                    } else if (emptySpaces > 0) {
                        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —Ñ–∏—à–∫—É –≤–Ω–∏–∑
                        gameState.board[row + emptySpaces][col] = gameState.board[row][col];
                        gameState.board[row][col] = 0;
                        
                        const cell = document.querySelector(`.cell[data-row="${row + emptySpaces}"][data-col="${col}"] .gem`);
                        if (cell) {
                            cell.classList.add('falling');
                        }
                    }
                }
                
                // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—É—Å—Ç–æ—Ç –Ω–æ–≤—ã–º–∏ —Ñ–∏—à–∫–∞–º–∏ —Å–≤–µ—Ä—Ö—É
                for (let row = 0; row < emptySpaces; row++) {
                    gameState.board[row][col] = Math.floor(Math.random() * GEM_TYPES) + 1;
                    
                    const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"] .gem`);
                    if (cell) {
                        cell.classList.add('spawning');
                    }
                }
            }
            
            renderBoard();
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        // ===== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò =====
        function hasPossibleMoves() {
            // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ö–æ–¥–æ–≤
            for (let row = 0; row < BOARD_SIZE; row++) {
                for (let col = 0; col < BOARD_SIZE - 1; col++) {
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –æ–±–º–µ–Ω–∞
                    [gameState.board[row][col], gameState.board[row][col+1]] = 
                    [gameState.board[row][col+1], gameState.board[row][col]];
                    
                    if (findMatches().length > 0) {
                        [gameState.board[row][col], gameState.board[row][col+1]] = 
                        [gameState.board[row][col+1], gameState.board[row][col]];
                        return true;
                    }
                    
                    [gameState.board[row][col], gameState.board[row][col+1]] = 
                    [gameState.board[row][col+1], gameState.board[row][col]];
                }
            }
            
            for (let col = 0; col < BOARD_SIZE; col++) {
                for (let row = 0; row < BOARD_SIZE - 1; row++) {
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ –æ–±–º–µ–Ω–∞
                    [gameState.board[row][col], gameState.board[row+1][col]] = 
                    [gameState.board[row+1][col], gameState.board[row][col]];
                    
                    if (findMatches().length > 0) {
                        [gameState.board[row][col], gameState.board[row+1][col]] = 
                        [gameState.board[row+1][col], gameState.board[row][col]];
                        return true;
                    }
                    
                    [gameState.board[row][col], gameState.board[row+1][col]] = 
                    [gameState.board[row+1][col], gameState.board[row][col]];
                }
            }
            
            return false;
        }

        function updateUI() {
            scoreElement.textContent = gameState.score;
            movesElement.textContent = gameState.moves;
            levelElement.textContent = gameState.level;
            targetElement.textContent = gameState.target;
            comboElement.textContent = `x${gameState.combo}`;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
            const progress = Math.min((gameState.score / gameState.target) * 100, 100);
            progressBar.style.width = `${progress}%`;
        }

        function checkWinCondition() {
            if (gameState.score >= gameState.target) {
                showWinModal();
            } else if (gameState.moves <= 0) {
                setTimeout(() => {
                    alert('–•–æ–¥—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                    resetGame();
                }, 500);
            }
        }

        function showWinModal() {
            finalScoreElement.textContent = gameState.score;
            finalComboElement.textContent = gameState.combo;
            winModal.classList.remove('hidden');
        }

        function nextLevel() {
            gameState.level++;
            gameState.target = LEVEL_TARGETS[gameState.level - 1] || (gameState.level * 2000);
            gameState.moves = LEVEL_MOVES[gameState.level - 1] || 15;
            gameState.score = 0;
            gameState.combo = 1;
            gameState.comboMultiplier = 1;
            
            createBoard();
            renderBoard();
            updateUI();
            winModal.classList.add('hidden');
        }

        function resetGame() {
            gameState.score = 0;
            gameState.moves = LEVEL_MOVES[gameState.level - 1] || 25;
            gameState.combo = 1;
            gameState.comboMultiplier = 1;
            
            createBoard();
            renderBoard();
            updateUI();
        }

        function checkPremiumStatus() {
            // –í —Ä–µ–∞–ª—å–Ω–æ–π –∏–≥—Ä–µ –∑–¥–µ—Å—å –∑–∞–ø—Ä–æ—Å –∫ –±—ç–∫–µ–Ω–¥—É
            // gameState.premium = await checkUserPremiumStatus(tg.initDataUnsafe.user.id);
            
            if (gameState.premium) {
                document.getElementById('premium-btn').textContent = 'üåü –ü–†–ï–ú–ò–£–ú';
                // –°–∫—Ä—ã—Ç—å —Ä–µ–∫–ª–∞–º—É –∏ —Ç.–¥.
            }
        }

        function showHint() {
            if (gameState.moves <= 0 || gameState.isAnimating) return;
            
            // –ü–æ–∏—Å–∫ –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ —Ö–æ–¥–∞
            for (let row = 0; row < BOARD_SIZE; row++) {
                for (let col = 0; col < BOARD_SIZE - 1; col++) {
                    [gameState.board[row][col], gameState.board[row][col+1]] = 
                    [gameState.board[row][col+1], gameState.board[row][col]];
                    
                    if (findMatches().length > 0) {
                        [gameState.board[row][col], gameState.board[row][col+1]] = 
                        [gameState.board[row][col+1], gameState.board[row][col]];
                        
                        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏
                        const cell1 = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
                        const cell2 = document.querySelector(`.cell[data-row="${row}"][data-col="${col+1}"]`);
                        
                        cell1.style.animation = 'pulse 1s infinite';
                        cell2.style.animation = 'pulse 1s infinite';
                        
                        setTimeout(() => {
                            cell1.style.animation = '';
                            cell2.style.animation = '';
                        }, 2000);
                        
                        return;
                    }
                    
                    [gameState.board[row][col], gameState.board[row][col+1]] = 
                    [gameState.board[row][col+1], gameState.board[row][col]];
                }
            }
        }

        // ===== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô =====
        document.getElementById('hint-btn').addEventListener('click', showHint);
        document.getElementById('restart-btn').addEventListener('click', resetGame);
        document.getElementById('next-level-btn').addEventListener('click', nextLevel);
        document.getElementById('premium-btn').addEventListener('click', () => {
            tg.showPopup({
                title: '–ü—Ä–µ–º–∏—É–º –ü–æ–¥–ø–∏—Å–∫–∞',
                message: '–ü–æ–ª—É—á–∏—Ç–µ –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏, —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –∫—Ä–∏—Å—Ç–∞–ª–ª—ã –∏ –æ—Ç–∫–ª—é—á–∏—Ç–µ —Ä–µ–∫–ª–∞–º—É!',
                buttons: [
                    { id: 'buy', type: 'default', text: '–ö—É–ø–∏—Ç—å –∑–∞ 299‚ÇΩ/–º–µ—Å' },
                    { type: 'cancel' }
                ]
            });
        });

        // ===== –ó–ê–ü–£–°–ö –ò–ì–†–´ =====
        initGame();

        // –°–∏–º—É–ª—è—Ü–∏—è —Ä–µ–∫–ª–∞–º—ã (–¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
        setInterval(() => {
            if (!gameState.premium && !document.querySelector('.modal:not(.hidden)')) {
                // –ü–æ–∫–∞–∑ —Ä–µ–∫–ª–∞–º–Ω–æ–≥–æ –±–∞–Ω–Ω–µ—Ä–∞
                console.log('–ü–æ–∫–∞–∑ —Ä–µ–∫–ª–∞–º—ã...');
            }
        }, 60000);
    </script>
</body>
</html>
